<html>

<body>
	<script>

		let day21inputTest = `../.# => ##./#../...
.#./..#/### => #..#/..../..../#..#`;
		let day21input = `../.. => ..#/#.#/###
#./.. => .#./#../###
##/.. => #.#/#.#/..#
.#/#. => .##/..#/#..
##/#. => #../#.#/#..
##/## => #.#/.#./#..
.../.../... => ####/##../#.../#...
#../.../... => ##.#/####/.#../....
.#./.../... => ...#/...#/#.../.##.
##./.../... => ###./#.##/#..#/...#
#.#/.../... => ##.#/###./.#.#/##..
###/.../... => .###/#..#/..##/.##.
.#./#../... => ####/#..#/#..#/#..#
##./#../... => #.##/###./##../#...
..#/#../... => ..##/.#.#/..#./.###
#.#/#../... => .##./.#../..#./###.
.##/#../... => ####/..../###./###.
###/#../... => .#.#/.###/##.#/#..#
.../.#./... => ..../.#../.##./..#.
#../.#./... => #.##/..#./####/#.##
.#./.#./... => .#.#/.###/#.#./.#.#
##./.#./... => #..#/#.#./...#/.###
#.#/.#./... => .##./#..#/####/.###
###/.#./... => #.../..../.#.#/##..
.#./##./... => #..#/..##/.##./.#.#
##./##./... => ..##/#..#/####/###.
..#/##./... => ####/.#.#/#.##/#.##
#.#/##./... => .###/...#/#.../...#
.##/##./... => ..##/.#.#/#.../##.#
###/##./... => ##../..#./..#./#...
.../#.#/... => .#.#/##../#..#/.#.#
#../#.#/... => #.##/...#/##../...#
.#./#.#/... => #.../..##/#..#/.##.
##./#.#/... => .##./..##/.#../..#.
#.#/#.#/... => .#../#..#/#.#./....
###/#.#/... => ##.#/..##/##../#...
.../###/... => #.../..#./##../#.##
#../###/... => ..#./#.../##../.##.
.#./###/... => ###./.#.#/..##/##.#
##./###/... => ##.#/#.../##.#/#.#.
#.#/###/... => ..##/...#/##../#..#
###/###/... => ##.#/.###/...#/#..#
..#/.../#.. => .##./#.##/..#./####
#.#/.../#.. => ..#./###./#.../##.#
.##/.../#.. => ...#/...#/.#../.###
###/.../#.. => .##./.#../##../#.#.
.##/#../#.. => ####/..##/#.../##..
###/#../#.. => #.../#..#/####/##..
..#/.#./#.. => .##./##.#/.#../###.
#.#/.#./#.. => ..../.###/###./.#.#
.##/.#./#.. => #.##/#..#/###./..#.
###/.#./#.. => #.../..#./##../.#.#
.##/##./#.. => .##./.#.#/#..#/#..#
###/##./#.. => .#../.#.#/#..#/....
#../..#/#.. => ####/..##/..##/.###
.#./..#/#.. => ###./.###/..#./##.#
##./..#/#.. => .###/####/#.../#.##
#.#/..#/#.. => #.##/#..#/.#.#/...#
.##/..#/#.. => #.../##../..##/##.#
###/..#/#.. => ###./##.#/#.../.#..
#../#.#/#.. => #.#./#.../##../..#.
.#./#.#/#.. => .###/#.#./...#/##.#
##./#.#/#.. => .#../#.##/##.#/#.#.
..#/#.#/#.. => .#../#..#/.#../.#.#
#.#/#.#/#.. => .#../.##./..../..#.
.##/#.#/#.. => .##./.#../####/#.##
###/#.#/#.. => ..#./##../##../#.#.
#../.##/#.. => #.##/.##./..#./..##
.#./.##/#.. => ###./#.#./#.../###.
##./.##/#.. => ####/#.../#.../#.#.
#.#/.##/#.. => .###/#..#/###./#..#
.##/.##/#.. => #.../####/###./###.
###/.##/#.. => .#../.#.#/##../.#..
#../###/#.. => ..#./.##./.###/##..
.#./###/#.. => ####/.##./####/....
##./###/#.. => #.../#.../#.##/.##.
..#/###/#.. => .#.#/.###/...#/....
#.#/###/#.. => ###./..##/.#../#.##
.##/###/#.. => ...#/.#../##../.#..
###/###/#.. => ...#/#.##/.#.#/..##
.#./#.#/.#. => .###/#.../..#./.##.
##./#.#/.#. => ###./##.#/..#./##.#
#.#/#.#/.#. => #.../##.#/..#./#...
###/#.#/.#. => ...#/...#/#..#/...#
.#./###/.#. => #.#./.##./#.#./.###
##./###/.#. => #.../####/..##/#...
#.#/###/.#. => ##../.##./.###/###.
###/###/.#. => ..#./.##./.#../#.#.
#.#/..#/##. => ...#/#.##/##../...#
###/..#/##. => ...#/#.../###./###.
.##/#.#/##. => ##.#/.#.#/.#../....
###/#.#/##. => .##./..../##.#/..#.
#.#/.##/##. => .#../###./#.#./##..
###/.##/##. => #.##/#..#/#.#./###.
.##/###/##. => #.##/###./..../##..
###/###/##. => .#../####/.###/##..
#.#/.../#.# => #.../#..#/..##/##.#
###/.../#.# => #..#/.#.#/####/#.##
###/#../#.# => ###./##../##.#/...#
#.#/.#./#.# => .##./.#.#/#.../...#
###/.#./#.# => .#../.#../..../#.#.
###/##./#.# => #.#./#.#./#.../.#..
#.#/#.#/#.# => ..../####/####/..#.
###/#.#/#.# => #..#/.##./#.../##..
#.#/###/#.# => ###./...#/#.##/##..
###/###/#.# => #.##/#.../#..#/###.
###/#.#/### => ..../...#/###./..#.
###/###/### => #..#/..../#.../#.##`;

		class FractalArt{
			constructor(enhancementRulesString){
				this.rules = this.extractRules(enhancementRulesString);
				this.start = [
					['.','#','.'],
					['.','.','#'],
					['#','#','#']
				];
				this.currentMatrix = this.start;
			}
			extractRules(enhancementRulesString) {
				return enhancementRulesString
					.split('\n')
					.map(ruleString => this.extractRule(ruleString));
			}
			extractRule(ruleString){
				let [source, target] = ruleString.split(' => ');
				return new Rule(source, target);
			}
			concatMatrixes(matrixes){
				let size = Math.sqrt(matrixes.length);
				
				let newMatrix = this.createEmptyMatrix(matrixes[0].length * size);

				for (let mi = 0; mi < size; mi++) {
					for (let mj = 0; mj < size; mj++) {
						let currentIndex = mi * size + mj;
						let currentMatrix = matrixes[currentIndex];
						let msize = currentMatrix.length;
						for (let i = 0; i < msize; i++) {
							for (let j = 0; j < msize; j++) {
								newMatrix[mi*msize+i][mj*msize+j] = currentMatrix[i][j]
							}
						}
					}
				}
				return newMatrix;
			}

			createEmptyMatrix(size) {
				let array = []
				for (let i = 0; i < size; i++) {
					let innerArray = [];
					for (let j = 0; j < size; j++) {
						innerArray.push(null);
					}
					array.push(innerArray);
				}
				return array;
			}

			step() {
				// debugger;
				let currentMatrix = new Matrix(this.currentMatrix);
				let parts = currentMatrix.splitMatrix();
				let newParts = parts.map((part)=>{
					let partMatrix = new Matrix(part);
					let selectedRule = this.rules.find(rule=>partMatrix.compareVariants(rule.key))
					return selectedRule.value;
				});
				this.currentMatrix = this.concatMatrixes(newParts);
			}

			steps(count){
				for(let i=0;i<count;i++){
					this.step();
				}
			}
			
			countHashes(){
				return this.currentMatrix
						.map(row=> row.reduce((sum,el)=>sum+=(el=='#'?1:0),0))
						.reduce((sum, rowSum)=>sum+=rowSum,0)
			}

			partA(){
				this.steps(5);
				console.log(this.countHashes());
			}

			partB(){
				this.steps(18);
				console.log(this.countHashes());
			}
			
		}
		class Rule{
			constructor(keyString, valueString){
				this.key = this.stringToArray(keyString);
				this.value = this.stringToArray(valueString);
			}
			stringToArray(text){
				return text
					.split('/')
					.map(textRow=>[...textRow])
			}
		}

		class Matrix{
			constructor(array){
				this.matrix = array;
				this.size = array.length;
			}

			getFragemnt(leftTopCorner, size){
				let {x,y} = leftTopCorner;
				let newMatrix = this.createEmptyMatrix(size);
				for (let i = 0; i < size; i++) {
					for (let j = 0; j < size; j++) {
						newMatrix[i][j] = this.matrix[x+i][y+j];
					}
				}
				return newMatrix;
			}

			splitMatrix(){
				let msize = ((this.size % 2) == 0) ? 2 : 3;
				let divider = this.size / msize;
				let partsAmount = divider * divider;
				let newArray = [];
				for (let i = 0; i < this.size; i+=msize) {
					for (let j = 0; j < this.size; j+=msize) {
						newArray.push(this.getFragemnt({x:i,y:j},msize))
					}
				}
				return newArray;
			}

			rotate90(){
				let size = this.size;
				let newMatrix = this.createEmptyMatrix(size);
				for (let i = 0; i < size; i++) {
					for (let j = 0; j < size; j++) {
						newMatrix[i][j] = this.matrix[j][size-1-i];
					}
				}
				return newMatrix;
			}
			flipH(){
				let size = this.size;
				let newMatrix = this.createEmptyMatrix(size);
				for (let i = 0; i < size; i++) {
					for (let j = 0; j < size; j++) {
						newMatrix[i][j] = this.matrix[size - 1 - i][j];
					}
				}
				return newMatrix;
			}
			flipV(){
				let size = this.size;
				let newMatrix = this.createEmptyMatrix(size);
				for (let i = 0; i < size; i++) {
					for (let j = 0; j < size; j++) {
						newMatrix[i][j] = this.matrix[i][size - 1 - j];
					}
				}
				return newMatrix;
			}
			same(one, two){
				if(one.length != two.length) return false;
				let size = one.length;
				for (let i = 0; i < size; i++) {
					for (let j = 0; j < size; j++) {
						if(one[i][j] != two[i][j]) return false; 
					}
				}
				return true;
			}

			compareVariants(otherMatrix){
				let variants = []
				let m = this;
				
				for(let i=0;i<4;i++){
					variants.push(m.matrix);
					variants.push(m.flipH());
					variants.push(m.flipV());
					m = new Matrix(m.rotate90())
				}
				return variants.some((variant)=>this.same(variant,otherMatrix))
			}

			createEmptyMatrix(size){
				let array = []
				for(let i=0;i<size;i++){
					let innerArray = [];
					for (let j = 0; j < size; j++) {
						innerArray.push(null);
					}
					array.push(innerArray);
				}
				return array;
			}
		}


		let fractalArtTest = new FractalArt(day21inputTest);
		/* let a = fractalArtTest.concatMatrixes([
			[[1,2], [5,6]],
			[[3,4], [7,8]],
			[[9,10], [13,14]],
			[[11,12], [15,16]]
		]);
		let b = new Matrix(a);
		let c = b.splitMatrix();
		let d = fractalArtTest.concatMatrixes(c);
		console.log(a,b,c, d); */
		/* let a = fractalArtTest.concatMatrixes([
			[
				["#", "#", "."],
				["#", ".", "."],
				[".", ".", "."]
			],
			[
				["#", "#", "."],
				["#", ".", "."],
				[".", ".", "."]
			],
			[
				["#", "#", "."],
				["#", ".", "."],
				[".", ".", "."]
			],
			[
				["#", "#", "."],
				["#", ".", "."],
				[".", ".", "."]
			]
		]);
		let b = new Matrix(a);
		let c = b.splitMatrix();
		let d = fractalArtTest.concatMatrixes(c);
		console.log(a,b,c, d); */

		fractalArtTest.steps(2);
		console.log(fractalArtTest.countHashes());

		let fractalArt = new FractalArt(day21input);
		fractalArt.partA();
		let fractalArtB = new FractalArt(day21input);
		fractalArtB.partB();


	</script>
</body>
</html>